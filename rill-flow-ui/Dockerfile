FROM node:16-alpine as build-stage

WORKDIR /data/rill-flow-ui
COPY . ./

# è®¾ç½® node é˜¿é‡Œé•œåƒ
RUN npm config set registry https://registry.npm.taobao.org

# è®¾ç½®é˜¿é‡Œé•œåƒã€pnpmã€ä¾èµ–ã€ç¼–è¯‘
RUN npm install pnpm -g && pnpm install && pnpm build:prod
# nodeéƒ¨åˆ†ç»“æŸ

RUN echo "ğŸ‰ ç¼– ğŸ‰ è¯‘ ğŸ‰ æˆ ğŸ‰ åŠŸ ğŸ‰"

FROM nginx:1.23.3-alpine as production-stage
COPY --from=build-stage /data/rill-flow-ui/dist /usr/share/nginx/html/dist
COPY --from=build-stage /data/rill-flow-ui/deploy/nginx.conf /etc/nginx/nginx.conf.template

RUN echo "ğŸ‰  å¯åŠ¨æœåŠ¡  ğŸ‰"

# å¯åŠ¨ Nginx æœåŠ¡
# åœ¨å®¹å™¨å¯åŠ¨æ—¶æ›¿æ¢ Nginx é…ç½®æ–‡ä»¶ä¸­çš„æ¨¡æ¿å˜é‡
CMD /bin/sh -c "envsubst '\$BACKEND_SERVER' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
RUN echo "ğŸ‰ æ¶ ğŸ‰ è®¾ ğŸ‰ æˆ ğŸ‰ åŠŸ ğŸ‰"

